<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI漫剧大师</title>
    <style>
        /* --- 1. 全局变量与重置 --- */
        :root {
            --bg-color: #FFFFFF;
            --text-main: #1F2937;
            --text-sub: #6B7280;
            --primary-gradient: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 100%);
            --tech-border-gradient: linear-gradient(135deg, #60A5FA, #C084FC, #F472B6);
            --tech-text-gradient: linear-gradient(90deg, #3B82F6, #8B5CF6, #EC4899);
            --step-gradient-bg: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            --font-stack: "Source Han Sans SC", "Noto Sans SC", "PingFang SC", "Microsoft YaHei", sans-serif;
            --safe-area-bottom: env(safe-area-inset-bottom);
            --tab-height: 56px;
            --tab-total-height: calc(var(--tab-height) + var(--safe-area-bottom));
            --page-padding: 20px; /* 统一边距变量 */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0;
            font-family: var(--font-stack);
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }
        
        ::-webkit-scrollbar { display: none; }
        .clickable:active { opacity: 0.7; transform: scale(0.98); }

        /* --- 2. 页面容器架构 --- */
        .page-container { flex: 1; position: relative; overflow: hidden; }
        
        /* Tab 页 */
        .tab-page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto; padding-bottom: calc(var(--tab-total-height) + 20px);
            display: none; background: #fff;
        }
        .tab-page.active { display: block; animation: fadeIn 0.2s ease; }

        /* 子页面 (详情页/全部历史) */
        .sub-page {
            position: fixed; top: 0; left: 0; width: 100%; 
            height: calc(100% - var(--tab-total-height)); 
            background: #fff; z-index: 200; 
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -5px 0 20px rgba(0,0,0,0.05);
        }
        .sub-page.active { transform: translateX(0); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- 3. 通用组件样式 --- */

        /* 科技感边框 */
        .tech-border {
            background: #FFFFFF; border-radius: 12px; position: relative;
            background: linear-gradient(#fff, #fff) padding-box, var(--tech-border-gradient) border-box;
            border: 1.5px solid transparent;
        }

        /* 导航栏 */
        .nav-bar {
            height: 44px; display: flex; align-items: center; justify-content: center;
            font-size: 16px; font-weight: 600; border-bottom: 1px solid #F3F4F6;
            position: relative; padding-top: var(--safe-area-bottom); background: #fff; flex-shrink: 0;
        }
        .nav-back { position: absolute; left: 16px; bottom: 10px; width: 24px; height: 24px; padding: 4px; }

        /* Banner */
        .banner {
            height: 180px; background: #F0F9FF; position: relative; flex-shrink: 0;
            display: flex; flex-direction: column; justify-content: center; 
            padding: 0 var(--page-padding); /* 调整边距 */
        }
        .banner-bg {
            position: absolute; inset: 0;
            background: radial-gradient(circle at 90% 10%, rgba(139, 92, 246, 0.15) 0%, transparent 40%),
                        radial-gradient(circle at 10% 90%, rgba(59, 130, 246, 0.15) 0%, transparent 40%);
        }
        .banner-content { position: relative; z-index: 2; margin-top: -10px; }
        .banner-title {
            font-size: 26px; font-weight: 800; margin-bottom: 8px;
            background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .banner-desc { font-size: 13px; color: var(--text-sub); opacity: 0.8; line-height: 1.4; max-width: 80%; }

        /* 输入区 */
        .input-container { 
            padding: 0 var(--page-padding); /* 调整边距 */
            margin-top: -30px; position: relative; z-index: 20; 
        }
        .input-box { padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.04); }
        textarea {
            width: 100%; height: 160px; border: none; background: #FAFAFA;
            border-radius: 8px; padding: 12px; font-size: 15px; color: var(--text-main);
            resize: none; outline: none; font-family: var(--font-stack);
        }
        .placeholder-mock {
            position: absolute; top: 28px; left: 28px; right: 28px;
            font-size: 13px; color: #9CA3AF; line-height: 1.6; pointer-events: none;
        }
        .placeholder-mock.hidden { display: none; }

        /* 下拉选项 */
        .options-row { display: flex; gap: 12px; margin-top: 12px; }
        .select-wrapper {
            flex: 1; position: relative; height: 40px;
            background: #F9FAFB; border-radius: 8px;
            display: flex; align-items: center; padding: 0 12px;
            border: 1px solid #E5E7EB;
        }
        .select-wrapper select {
            width: 100%; height: 100%; border: none; background: transparent;
            font-size: 13px; color: #374151; outline: none; appearance: none;
        }
        .select-arrow { position: absolute; right: 10px; pointer-events: none; width: 10px; height: 10px; fill: #9CA3AF; }

        /* AI 托管炫彩文字 */
        .ai-text-center { display: flex; justify-content: center; margin: 16px 0; }
        .ai-text {
            font-size: 14px; font-weight: 800; font-style: italic;
            background: var(--tech-text-gradient);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            display: flex; align-items: center; letter-spacing: 1px;
        }

        /* 按钮 */
        .submit-btn {
            width: 100%; height: 48px;
            border: none; border-radius: 24px;
            background: var(--primary-gradient); color: white;
            display: flex; flex-direction: row;
            align-items: center; justify-content: center;
            gap: 6px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); transition: all 0.3s;
        }
        .submit-btn:disabled { background: #D1D5DB; box-shadow: none; cursor: not-allowed; }
        .btn-main-text { font-size: 16px; font-weight: 600; line-height: 1; }
        .btn-sub-text { font-size: 12px; opacity: 0.85; font-weight: 400; line-height: 1; margin-top: 2px; }
        
        .coin-link { text-align: center; margin-top: 12px; font-size: 12px; color: #6B7280; }
        .coin-link span { color: #D97706; font-weight: 600; text-decoration: underline; }

        /* 历史项目 */
        .section-header {
            padding: 24px var(--page-padding) 12px; /* 调整边距 */
            display: flex; align-items: center; justify-content: space-between;
            font-size: 16px; font-weight: 700;
        }
        .section-icon { width: 18px; height: 18px; margin-right: 6px; fill: url(#grad1); }
        /* 空心 Icon 样式 */
        .section-icon-outline { width: 18px; height: 18px; margin-right: 6px; stroke: url(#grad1); fill: none; stroke-width: 2; }
        
        .view-all-link { font-size: 12px; color: #8B5CF6; font-weight: 400; display: flex; align-items: center; }
        .count-badge { font-size: 13px; color: #9CA3AF; font-weight: 400; margin-left: 4px; }

        .history-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; 
            padding: 0 var(--page-padding); /* 调整边距 */
        }
        .history-card {
            background: #fff; border-radius: 12px; overflow: hidden;
            border: 1px solid #F3F4F6; position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        .status-tag {
            position: absolute; top: 6px; left: 6px; z-index: 2;
            font-size: 9px; padding: 2px 6px; border-radius: 4px; color: white;
            backdrop-filter: blur(4px);
        }
        .status-processing { background: rgba(59, 130, 246, 0.9); }
        .status-success { background: rgba(16, 185, 129, 0.9); }
        
        .h-img { width: 100%; height: 100px; background: #F3F4F6; object-fit: cover; display: block; }
        .h-info { padding: 8px; }
        .h-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .h-time { font-size: 10px; color: #9CA3AF; }

        /* 玩法介绍 */
        .guide-container {
            margin: 0 var(--page-padding) 30px; /* 调整边距 */
            background: #F9FAFB; border-radius: 12px;
            padding: 16px; border: 1px dashed #E5E7EB;
        }
        /* 增加高度 */
        .guide-scroll { max-height: 240px; overflow-y: auto; font-size: 12px; color: #4B5563; line-height: 1.6; }
        .guide-img-placeholder {
            width: 100%; height: 80px; background: #E5E7EB; border-radius: 6px;
            margin-top: 8px; display: flex; align-items: center; justify-content: center; color: #9CA3AF;
        }

        /* --- 4. 详情页 --- */
        .chat-container { 
            flex: 1; overflow-y: auto; 
            padding: var(--page-padding); /* 调整边距 */
            background: #F9FAFB; 
        }

        .user-msg-box {
            background: #fff; padding: 12px; border-radius: 12px; margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 3px solid #E5E7EB;
        }
        .user-header { font-size: 12px; color: #3B82F6; font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; }
        .user-avatar-mini { width: 16px; height: 16px; background: #E0E7FF; border-radius: 50%; margin-right: 6px; }
        .user-content { font-size: 14px; color: #374151; line-height: 1.5; max-height: 60px; overflow-y: auto; }

        /* 步骤卡片 */
        .tech-step-card {
            margin-bottom: 12px; padding: 12px;
            border-radius: 8px; position: relative;
            background: #fff;
            background: linear-gradient(#fff, #fff) padding-box, var(--tech-border-gradient) border-box;
            border: 1.5px solid transparent;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            opacity: 0; animation: slideUp 0.3s forwards;
            display: flex; align-items: center;
        }
        .step-icon-box {
            width: 28px; height: 28px; border-radius: 6px;
            background: var(--step-gradient-bg);
            display: flex; align-items: center; justify-content: center;
            margin-right: 12px; flex-shrink: 0;
        }
        .step-icon-box svg { width: 16px; height: 16px; fill: #8B5CF6; }
        .step-text { font-size: 13px; color: #374151; font-weight: 500; }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 剧本详情卡片 */
        .script-card {
            display: block; padding: 0; overflow: hidden;
        }
        .script-header {
            padding: 10px 12px; background: #F3F4F6; font-size: 12px; font-weight: 700; color: #4B5563;
            border-bottom: 1px solid #E5E7EB; display: flex; align-items: center; justify-content: space-between;
        }
        .script-content {
            padding: 12px; font-size: 13px; color: #374151; line-height: 1.8;
            max-height: 150px; overflow-y: auto; white-space: pre-wrap;
        }

        /* 结果图集 */
        .result-section { margin-top: 20px; animation: fadeIn 0.5s ease; }
        .result-gallery { display: flex; overflow-x: auto; gap: 12px; padding: 4px; scroll-snap-type: x mandatory; }
        .result-card {
            min-width: 260px; background: #fff; border-radius: 8px; overflow: hidden;
            border: 1px solid #E5E7EB; scroll-snap-align: center;
            display: flex; flex-direction: column;
        }
        
        /* 视觉区域 */
        .visual-area {
            width: 100%; height: 146px; position: relative; background: #000;
        }
        .vis-img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .vis-prompt {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #1F2937; color: #D1D5DB; padding: 12px;
            font-size: 11px; line-height: 1.5; overflow-y: auto;
            display: none;
        }
        .vis-prompt.active { display: block; }
        
        .vis-toggle-btn {
            position: absolute; top: 8px; right: 8px; z-index: 10;
            background: rgba(0,0,0,0.6); color: white;
            font-size: 10px; padding: 4px 8px; border-radius: 12px;
            backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
        }

        .r-content { padding: 10px; flex: 1; display: flex; flex-direction: column; }
        .r-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .r-seq { font-size: 12px; font-weight: 700; color: #3B82F6; }
        .r-text { font-size: 12px; color: #4B5563; line-height: 1.4; height: 50px; overflow-y: auto; margin-bottom: 8px; }
        
        .r-item-actions {
            border-top: 1px solid #F3F4F6; padding-top: 8px; margin-top: auto;
            display: flex; justify-content: space-between; align-items: center;
        }
        .r-btn { 
            flex: 1; text-align: center; font-size: 10px; color: #6B7280; padding: 4px 0; 
            white-space: nowrap;
        }
        .r-divider { width: 1px; height: 12px; background: #E5E7EB; }

        .result-actions { margin-top: 20px; padding-bottom: 20px; }
        .action-btn {
            width: 100%; height: 44px; border-radius: 22px;
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; font-weight: 600; cursor: pointer;
        }
        .btn-fill { background: var(--primary-gradient); color: #fff; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }

        /* --- 5. 我的页面 --- */
        .mine-header { padding: 60px var(--page-padding) 30px; display: flex; align-items: center; }
        .avatar { width: 64px; height: 64px; background: #E0E7FF; border-radius: 50%; margin-right: 16px; border: 2px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .nickname { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
        .user-id { font-size: 12px; color: #6B7280; }
        
        .asset-card {
            margin: 0 var(--page-padding); background: #1F2937; color: #FCD34D;
            padding: 20px; border-radius: 16px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 8px 20px rgba(31, 41, 55, 0.2);
        }
        
        .menu-list { margin-top: 20px; padding: 0 var(--page-padding); }
        .menu-item {
            display: flex; align-items: center; padding: 16px 0;
            border-bottom: 1px solid #F3F4F6; cursor: pointer;
        }
        .menu-icon { width: 20px; height: 20px; margin-right: 12px; fill: #6B7280; }
        .menu-text { flex: 1; font-size: 15px; color: #374151; }
        .menu-arrow { width: 16px; height: 16px; fill: #D1D5DB; }

        /* 底部 TabBar (常驻) */
        .tab-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: var(--tab-total-height);
            background: #FFFFFF; border-top: 1px solid #F3F4F6;
            display: flex; padding-bottom: var(--safe-area-bottom); 
            z-index: 300;
        }
        .tab-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 10px; color: #9CA3AF; cursor: pointer;
        }
        .tab-item.active { color: #3B82F6; }
        .tab-item svg { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; }

        /* Toast */
        .toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85); color: white; padding: 16px 24px;
            border-radius: 8px; font-size: 14px; z-index: 400;
            display: none; text-align: center; max-width: 80%; line-height: 1.5;
        }
    </style>
</head>
<body>

    <!-- SVG 定义 -->
    <svg width="0" height="0" style="position:absolute">
        <defs>
            <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#3B82F6;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#8B5CF6;stop-opacity:1" />
            </linearGradient>
        </defs>
    </svg>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <div class="page-container">
        
        <!-- Tab 1: 工作台 -->
        <div id="tab-workbench" class="tab-page active">
            <div class="banner">
                <div class="banner-bg"></div>
                <div class="banner-content">
                    <div class="banner-title">AI 漫剧大师</div>
                    <div class="banner-desc">输入灵感，AI 自动生成分镜。<br>让故事可视化从未如此简单。</div>
                </div>
            </div>

            <div class="input-container">
                <div class="tech-border input-box">
                    <div style="position: relative;">
                        <textarea id="storyInput" maxlength="30000"></textarea>
                        <div id="placeholder" class="placeholder-mock">
                            输入故事想法，或粘贴故事内容，AI智能生成完整剧本和分镜<br>
                            受长度限制，小说建议分章节生成
                        </div>
                    </div>

                    <div class="options-row">
                        <div class="select-wrapper">
                            <select><option>横版 16:9</option><option>竖版 9:16</option></select>
                            <svg class="select-arrow" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                        </div>
                        <div class="select-wrapper">
                            <select><option>真人写实</option><option>迪士尼</option><option>国漫</option><option>日漫</option><option>3D CG</option></select>
                            <svg class="select-arrow" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                        </div>
                    </div>

                    <div class="ai-text-center">
                        <div class="ai-text">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="url(#grad1)" style="margin-right:6px"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                            AI 全程托管模式
                        </div>
                    </div>

                    <button id="startBtn" class="submit-btn clickable" disabled onclick="startTask()">
                        <span class="btn-main-text">开始生成</span>
                        <span class="btn-sub-text">(120金币/次)</span>
                    </button>

                    <div class="coin-link">
                        我的金币：<span id="userCoinDisplay">1000</span>
                    </div>
                </div>
            </div>

            <!-- 历史项目 -->
            <div id="historySection" style="display:none">
                <div class="section-header">
                    <div style="display:flex; align-items:center">
                        <svg class="section-icon" viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
                        历史项目 <span id="historyCount" class="count-badge">(0)</span>
                    </div>
                    <div class="view-all-link clickable" onclick="openFullHistory()">
                        全部历史 <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                    </div>
                </div>
                <div id="workbenchHistoryGrid" class="history-grid">
                    <!-- JS 动态插入 -->
                </div>
            </div>

            <div class="section-header">
                <div style="display:flex; align-items:center">
                    <!-- 修改：空心 Icon -->
                    <svg class="section-icon-outline" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                    玩法介绍
                </div>
            </div>
            <div class="guide-container">
                <div class="guide-scroll">
                    <p><strong>1. 输入创意：</strong> 支持输入简短的故事梗概，或者直接粘贴小说章节内容。</p>
                    <p><strong>2. 风格选择：</strong> 根据故事类型选择合适的画面比例和视觉风格。</p>
                    <p><strong>3. 全程托管：</strong> 点击开始后，AI 将自动完成编剧、分镜策划、画面生成全流程。</p>
                    <div class="guide-img-placeholder">示意图：操作流程演示</div>
                    <p><strong>4. 结果导出：</strong> 生成完成后，可下载分镜图或复制描述词，前往视频工具制作。</p>
                </div>
            </div>
        </div>

        <!-- Tab 2: 我的 -->
        <div id="tab-mine" class="tab-page">
            <div class="mine-header">
                <div class="avatar"></div>
                <div>
                    <div class="nickname">微信用户</div>
                    <div class="user-id">ID: 8839201</div>
                </div>
            </div>
            
            <div class="asset-card">
                <div>
                    <div style="font-size:12px; opacity:0.8; margin-bottom:4px;">剩余金币</div>
                    <div style="font-size:26px; font-weight:700;">1,000</div>
                </div>
                <div style="background:#FCD34D; color:#1F2937; padding:6px 18px; border-radius:20px; font-size:13px; font-weight:600;">充值</div>
            </div>

            <div class="menu-list">
                <div class="menu-item">
                    <svg class="menu-icon" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 12h-2v-2h2v2zm0-4h-2V6h2v4z"/></svg>
                    <div class="menu-text">使用帮助</div>
                    <svg class="menu-arrow" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                </div>
                <div class="menu-item">
                    <svg class="menu-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                    <div class="menu-text">隐私政策</div>
                    <svg class="menu-arrow" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                </div>
            </div>
        </div>

    </div>

    <!-- 子页面：全部历史列表 -->
    <div id="fullHistoryPage" class="sub-page">
        <div class="nav-bar">
            <div class="nav-back clickable" onclick="closeFullHistory()">
                <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            </div>
            <span>全部历史项目 <span id="fullHistoryCount" style="font-weight:400; font-size:14px; color:#6B7280">(0)</span></span>
        </div>
        <div style="flex:1; overflow-y:auto; padding:16px;">
            <div id="fullHistoryGrid" class="history-grid">
                <!-- JS 动态插入 -->
            </div>
        </div>
    </div>

    <!-- 子页面：项目详情 -->
    <div id="detailPage" class="sub-page">
        <div class="nav-bar">
            <div class="nav-back clickable" onclick="closeDetail()">
                <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            </div>
            <span>AI 漫剧大师</span>
        </div>

        <div class="chat-container" id="detailContent">
            <!-- 动态填充 -->
        </div>
    </div>

    <!-- 底部 TabBar (常驻) -->
    <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('workbench', this)">
            <svg viewBox="0 0 24 24"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z"/></svg>
            <span>工作台</span>
        </div>
        <div class="tab-item" onclick="switchTab('mine', this)">
            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            <span>我的</span>
        </div>
    </div>

    <script>
        // --- 全局状态 ---
        let historyData = [];
        let userCoins = 1000;
        const COST = 120;
        
        const STEPS_TEXT = [
            "收到故事设定，开始任务规划...",
            "正在拆解剧情结构...",
            "剧本编写完成，分镜师已就位",
            "分镜策划中，生成描述词...",
            "正在生成画面 (4/4)..."
        ];

        const DUMMY_SCRIPT = `【场景一：雨夜街头】\n\n角色：李明（男，25岁，神情疲惫）\n\n（镜头特写）雨水顺着李明的脸颊滑落，分不清是泪水还是雨水。他手中紧紧攥着一张被淋湿的信纸。\n\n李明（独白）：如果时间能倒流，我绝不会做出那个选择。\n\n（镜头拉远）霓虹灯在积水的路面上投下斑驳的倒影，一辆飞车呼啸而过，溅起水花。\n\n【场景二：回忆中的咖啡馆】\n\n角色：李明，安娜（女，24岁，笑容灿烂）\n\n阳光透过落地窗洒在桌面上。安娜递给李明一杯热咖啡。\n\n安娜：听说那边的世界很精彩，你真的决定要去了吗？\n\n李明：是的，这是改变命运的唯一机会。\n\n（镜头切换）李明眼中的光芒，那是对未来的无限憧憬。\n\n【场景三：赛博空间的边缘】\n\n巨大的全息广告牌闪烁着故障的蓝光。李明站在高楼边缘，俯瞰着这座钢铁丛林。\n\n系统音（OS）：连接已断开，请重试。\n\n李明苦笑一声，将手中的芯片抛向深渊。\n\n（此处省略800字...）`;

        // --- 1. Tab 切换 ---
        function switchTab(tabName, el) {
            document.querySelectorAll('.sub-page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
        }

        // --- 2. 输入框逻辑 ---
        const inputEl = document.getElementById('storyInput');
        const placeholderEl = document.getElementById('placeholder');
        const startBtn = document.getElementById('startBtn');

        inputEl.addEventListener('input', function() {
            placeholderEl.classList.toggle('hidden', this.value.length > 0);
            if (this.value.length > 30000) {
                showToast('字数过多，超出的部分无法输入，建议分批处理');
                this.value = this.value.substring(0, 30000);
            }
            startBtn.disabled = this.value.trim().length === 0;
        });

        // --- 3. 开始任务 ---
        function startTask() {
            if (userCoins < COST) { showToast('金币不足'); return; }
            
            const text = inputEl.value;
            const title = text.substring(0, 12) + (text.length > 12 ? '...' : '');
            const id = Date.now();
            const now = new Date();
            const timeStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
            
            const newItem = {
                id: id,
                title: title,
                text: text,
                time: timeStr,
                status: 'processing'
            };
            historyData.unshift(newItem);

            renderHistory();
            showToast('已开始全托管自动生成，在“历史项目”中可查看进度');
            
            inputEl.value = '';
            placeholderEl.classList.remove('hidden');
            startBtn.disabled = true;
        }

        // --- 4. 渲染历史列表 ---
        function renderHistory() {
            const section = document.getElementById('historySection');
            const wbGrid = document.getElementById('workbenchHistoryGrid');
            const fullGrid = document.getElementById('fullHistoryGrid');
            
            document.getElementById('historyCount').innerText = `(${historyData.length})`;
            document.getElementById('fullHistoryCount').innerText = `(${historyData.length})`;
            
            if (historyData.length > 0) {
                section.style.display = 'block';
            }

            const createCard = (item) => `
                <div class="history-card clickable" onclick="openDetail(${item.id})">
                    <div class="status-tag ${item.status === 'processing' ? 'status-processing' : 'status-success'}">
                        ${item.status === 'processing' ? '生成中' : '生成成功'}
                    </div>
                    <svg class="h-img" viewBox="0 0 100 100" preserveAspectRatio="none">
                        <rect width="100" height="100" fill="#F3F4F6"/>
                        <text x="50" y="50" font-size="10" fill="#9CA3AF" text-anchor="middle">分镜封面</text>
                    </svg>
                    <div class="h-info">
                        <div class="h-title">${item.title}</div>
                        <div class="h-time">${item.time}</div>
                    </div>
                </div>
            `;

            wbGrid.innerHTML = historyData.slice(0, 2).map(createCard).join('');
            fullGrid.innerHTML = historyData.map(createCard).join('');
        }

        function openFullHistory() {
            renderHistory();
            document.getElementById('fullHistoryPage').classList.add('active');
        }
        function closeFullHistory() {
            document.getElementById('fullHistoryPage').classList.remove('active');
        }

        // --- 5. 详情页逻辑 ---
        function openDetail(id) {
            const item = historyData.find(i => i.id === id);
            if (!item) return;

            const detailPage = document.getElementById('detailPage');
            const contentDiv = document.getElementById('detailContent');
            
            let html = `
                <div class="user-msg-box">
                    <div class="user-header">
                        <div class="user-avatar-mini"></div>
                        微信用户
                    </div>
                    <div class="user-content">${item.text}</div>
                </div>
                <div id="stepContainer"></div>
            `;
            contentDiv.innerHTML = html;
            detailPage.classList.add('active');

            const stepContainer = document.getElementById('stepContainer');

            if (item.status === 'processing') {
                playStepAnimation(item, stepContainer);
            } else {
                renderStaticSteps(stepContainer);
                renderResult(stepContainer);
            }
        }

        function closeDetail() {
            document.getElementById('detailPage').classList.remove('active');
        }

        function createStepCard(text) {
            return `
                <div class="tech-step-card">
                    <div class="step-icon-box">
                        <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    </div>
                    <div class="step-text">${text}</div>
                </div>
            `;
        }

        // 创建剧本详情卡片 (修改：增加复制图标)
        function createScriptCard() {
            return `
                <div class="tech-border script-card" style="margin-bottom:12px; animation: slideUp 0.3s forwards;">
                    <div class="script-header">
                        <div style="display:flex; align-items:center">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="#4B5563" style="margin-right:6px"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                            剧本详情
                        </div>
                        <svg class="clickable" width="16" height="16" viewBox="0 0 24 24" fill="#6B7280" onclick="showToast('剧本已复制')"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                    </div>
                    <div class="script-content">${DUMMY_SCRIPT}</div>
                </div>
            `;
        }

        function playStepAnimation(item, container) {
            let index = 0;
            function next() {
                if (index >= STEPS_TEXT.length) {
                    finishTask(item, container);
                    return;
                }
                
                const div = document.createElement('div');
                div.innerHTML = createStepCard(STEPS_TEXT[index]);
                container.appendChild(div.firstElementChild);
                
                if (STEPS_TEXT[index].includes("剧本编写完成")) {
                    const scriptDiv = document.createElement('div');
                    scriptDiv.innerHTML = createScriptCard();
                    container.appendChild(scriptDiv.firstElementChild);
                }

                container.parentElement.scrollTop = container.parentElement.scrollHeight;
                index++;
                setTimeout(next, 1000);
            }
            next();
        }

        function renderStaticSteps(container) {
            let html = '';
            STEPS_TEXT.forEach(text => { 
                html += createStepCard(text);
                if (text.includes("剧本编写完成")) {
                    html += createScriptCard();
                }
            });
            html += createStepCard("生成成功，任务结束");
            container.innerHTML = html;
        }

        function finishTask(item, container) {
            item.status = 'success';
            userCoins -= COST;
            document.getElementById('userCoinDisplay').innerText = userCoins.toLocaleString();
            renderHistory();
            
            const div = document.createElement('div');
            div.innerHTML = createStepCard("生成成功，任务结束");
            container.appendChild(div.firstElementChild);

            renderResult(container);
        }

        window.toggleVisual = function(btn) {
            const parent = btn.closest('.visual-area');
            const promptDiv = parent.querySelector('.vis-prompt');
            const isHidden = getComputedStyle(promptDiv).display === 'none';
            
            if (isHidden) {
                promptDiv.style.display = 'block';
                btn.innerText = '查看画面';
                btn.style.background = 'rgba(59, 130, 246, 0.8)';
            } else {
                promptDiv.style.display = 'none';
                btn.innerText = '查看提示词';
                btn.style.background = 'rgba(0,0,0,0.6)';
            }
        }

        function renderResult(container) {
            const resultHtml = `
                <div class="result-section">
                    <div style="font-size:12px; color:#6B7280; margin-bottom:8px;">分镜详情：</div>
                    <div class="result-gallery">
                        <!-- Card 1 -->
                        <div class="result-card">
                            <div class="visual-area">
                                <svg class="vis-img" viewBox="0 0 100 100" preserveAspectRatio="none">
                                    <rect width="100" height="100" fill="#E0E7FF"/>
                                    <text x="50" y="50" font-size="12" fill="#818CF8" text-anchor="middle">分镜画面 01</text>
                                </svg>
                                <div class="vis-prompt">Prompt: Cinematic shot, rain falling on face, sorrowful expression, cyberpunk city background, neon lights reflection, 8k resolution, unreal engine 5 render.</div>
                                <div class="vis-toggle-btn" onclick="toggleVisual(this)">查看提示词</div>
                            </div>
                            <div class="r-content">
                                <div class="r-header"><span class="r-seq">SCENE 01</span></div>
                                <div class="r-text">主角站在雨中，眼神坚毅，手中紧握着那封信...</div>
                                <div class="r-item-actions">
                                    <div class="r-btn clickable">复制描述</div>
                                    <div class="r-divider"></div>
                                    <div class="r-btn clickable">下载图片</div>
                                    <div class="r-divider"></div>
                                    <div class="r-btn clickable">复制提示词</div>
                                </div>
                            </div>
                        </div>
                        <!-- Card 2 -->
                        <div class="result-card">
                            <div class="visual-area">
                                <svg class="vis-img" viewBox="0 0 100 100" preserveAspectRatio="none">
                                    <rect width="100" height="100" fill="#E0E7FF"/>
                                    <text x="50" y="50" font-size="12" fill="#818CF8" text-anchor="middle">分镜画面 02</text>
                                </svg>
                                <div class="vis-prompt">Prompt: Wide angle shot, futuristic flying car passing by, splashing water, high contrast, blue and purple tone, blade runner style.</div>
                                <div class="vis-toggle-btn" onclick="toggleVisual(this)">查看提示词</div>
                            </div>
                            <div class="r-content">
                                <div class="r-header"><span class="r-seq">SCENE 02</span></div>
                                <div class="r-text">镜头拉远，城市霓虹灯闪烁，一辆飞车掠过...</div>
                                <div class="r-item-actions">
                                    <div class="r-btn clickable">复制描述</div>
                                    <div class="r-divider"></div>
                                    <div class="r-btn clickable">下载图片</div>
                                    <div class="r-divider"></div>
                                    <div class="r-btn clickable">复制提示词</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 修改：仅保留导出完整文档按钮 -->
                    <div class="result-actions">
                        <div class="action-btn btn-fill clickable">导出(剧本+分镜)完整文档</div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', resultHtml);
            container.parentElement.scrollTop = container.parentElement.scrollHeight;
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2000);
        }
    </script>
</body>
</html>
